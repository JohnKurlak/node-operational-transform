<!DOCTYPE html>
<html>
    <head>
        <link rel="stylesheet" type="text/css" href="reset.css" />
        <style type="text/css">
        textarea {
            box-sizing: border-box;
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
            padding: 15px 20px;
        }
        </style>
    </head>
    <body>
        <form>
            <textarea></textarea>
        </form>
        <script type="text/javascript" src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
        <script type="text/javascript" src="../dist/client.js"></script>
        <script type="text/javascript">
            var KEY_CODE = {
                BACKSPACE: 8,
                DELETE: 46,
            };
            var textarea = document.querySelector('textarea');

            textarea.focus();

            textarea.addEventListener('keypress', function (e) {
                nodeOTCient.commit({
                    type: 'insert',
                    text: String.fromCharCode(e.keyCode),
                    start: this.selectionStart,
                    end: this.selectionEnd,
                });
            });

            textarea.addEventListener('paste', function (e) {
                nodeOTCient.commit({
                    type: 'insert',
                    text: e.clipboardData.getData('text'),
                    start: this.selectionStart,
                    end: this.selectionEnd,
                })
            });

            textarea.addEventListener('keydown', function (e) {
                var isBackspaceKey = (e.keyCode === KEY_CODE.BACKSPACE);
                var isDeleteKey = (e.keyCode === KEY_CODE.DELETE);

                if (!isBackspaceKey && !isDeleteKey) {
                    return;
                }

                var isSingleDelete = (this.selectionStart === this.selectionEnd);
                var isAtFirstCharacter = (this.selectionStart === 0);
                var isAtLastCharacter = (this.selectionEnd === textarea.length - 1);

                var deleteText = '';
                var deleteStart = this.selectionStart;
                var deleteEnd = this.selectionEnd;

                if (isSingleDelete) {
                    if (isBackspaceKey && !isAtFirstCharacter) {
                        deleteText = textarea.value.substring(this.selectionStart - 1, this.selectionStart);
                    } else if (isDeleteKey && !isAtLastCharacter) {
                        deleteText = textarea.value.substring(this.selectionEnd, this.selectionEnd + 1);
                        ++deleteStart;
                        ++deleteEnd;
                    }
                } else {
                    deleteText = textarea.value.substring(this.selectionStart, this.selectionEnd);
                }

                if (deleteText.length === 0) {
                    return;
                }

                nodeOTCient.commit({
                    type: 'delete',
                    text: deleteText,
                    start: deleteStart,
                    end: deleteEnd,
                });
            });

            var nodeOTCient = NodeOTClient.for(
                'http://localhost:3000',
                window.location.hash.substring(1) || 'PPBqWA9'
            );
            nodeOTCient.on('merge', merge);

            function merge(operation) {
                if (operation.type === 'insert') {
                    textarea.value = textarea.value.substring(0, operation.start) + operation.text + textarea.value.substring(operation.end);
                } else if (operation.type === 'delete') {
                    var deleteStart = (operation.start === operation.end) ? operation.start - 1 : operation.start;
                    var deleteEnd = Math.max(operation.end, operation.start - 1);
                    textarea.value = textarea.value.substring(0, deleteStart) + textarea.value.substring(deleteEnd);
                }
            }

            window.addEventListener('hashchange', function (e) {
                var hash = window.location.hash.substring(1);
                if (hash === '') {
                    return;
                }

                var operation = JSON.parse(hash);

                textarea.selectionStart = operation.start;
                textarea.selectionEnd = operation.end;

                if (operation.type === 'insert') {
                    merge(operation);
                    for (var i = 0; i < operation.text.length; ++i) {
                        sendKey(textarea, operation.text.charCodeAt(i));
                        textarea.selectionStart = textarea.selectionEnd = textarea.selectionStart + 1;
                    }
                } else if (operation.type === 'delete') {
                    sendKey(textarea, KEY_CODE.BACKSPACE);
                    merge(operation);
                }
            });

            function sendKey(textarea, charCode) {
                var keydown = document.createEvent('KeyboardEvent');
                Object.defineProperty(keydown, 'keyCode', {
                    get: function () {
                        return charCode;
                    }
                });

                var keypress = document.createEvent('KeyboardEvent');
                Object.defineProperty(keypress, 'keyCode', {
                    get: function () {
                        return charCode;
                    }
                });

                keydown.initKeyboardEvent('keydown', true, true, document.defaultView);
                keypress.initKeyboardEvent('keypress', true, true, document.defaultView);

                textarea.dispatchEvent(keydown);
                textarea.dispatchEvent(keypress);
            }
        </script>
    </body>
</html>