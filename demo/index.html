<!DOCTYPE html>
<html>
    <head>
        <link rel="stylesheet" type="text/css" href="reset.css" />
        <style type="text/css">
        textarea {
            box-sizing: border-box;
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
            padding: 15px 20px;
        }
        </style>
    </head>
    <body>
        <form>
            <textarea></textarea>
        </form>
        <script type="text/javascript" src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
        <script type="text/javascript" src="../dist/client.js"></script>
        <script type="text/javascript">
            var KEY_CODE = {
                BACKSPACE: 8,
            }
            var textarea = document.querySelector('textarea');

            textarea.focus();

            textarea.addEventListener('keypress', function (e) {
                nodeOTCient.commit({
                    type: 'insert',
                    text: String.fromCharCode(e.keyCode),
                    start: this.selectionStart,
                    end: this.selectionEnd,
                });
            });

            textarea.addEventListener('keydown', function (e) {
                if (e.keyCode !== KEY_CODE.BACKSPACE || (this.selectionStart === 0 && this.selectionEnd === 0)) {
                    return;
                }

                var deleteStart = (this.selectionStart === this.selectionEnd) ? this.selectionStart - 1 : this.selectionStart;
                var deleteEnd = Math.max(this.selectionEnd, this.selectionStart - 1);
                var deleteText = this.value.substring(deleteStart, deleteEnd + 1);

                nodeOTCient.commit({
                    type: 'delete',
                    text: deleteText,
                    start: deleteStart,
                    end: deleteEnd,
                });
            });

            var nodeOTCient = NodeOTClient.for(
                'http://localhost:3000',
                window.location.hash.substring(1) || 'PPBqWA9'
            );

            nodeOTCient.on('merge', function (operation) {
                if (operation.type === 'insert') {
                    textarea.value = textarea.value.substring(0, operation.start) + operation.text + textarea.value.substring(operation.end);
                } else if (operation.type === 'delete') {
                    textarea.value = textarea.value.substring(0, operation.start) + textarea.value.substring(operation.end);
                }
            });
        </script>
    </body>
</html>