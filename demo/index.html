<!DOCTYPE html>
<html>
    <head>
        <link rel="stylesheet" type="text/css" href="reset.css" />
        <style type="text/css">
        textarea {
            box-sizing: border-box;
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
            padding: 15px 20px;
            font-family: Inconsolata, Monaco, Consolas, monospace;
        }
        </style>
    </head>
    <body>
        <form>
            <textarea></textarea>
        </form>
        <script type="text/javascript" src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
        <script type="text/javascript">
        const originalLog = console.log;
        console.log = (...args) => {
            originalLog.apply(null, [window.location.search.substring(4), ...args]);
        };
        </script>
        <script type="text/javascript" src="../dist/client.js"></script>
        <script type="text/javascript">
            var KEY_CODE = {
                BACKSPACE: 8,
                DELETE: 46,
            };
            var textarea = document.querySelector('textarea');

            textarea.focus();

            // TODO: Move document logic into separate adapter file

            textarea.addEventListener('keypress', function (e) {
                nodeOTCient.commit({
                    type: 'insert',
                    text: String.fromCharCode(e.keyCode),
                    index: this.selectionStart,
                });
            });

            textarea.addEventListener('paste', function (e) {
                nodeOTCient.commit({
                    type: 'insert',
                    text: e.clipboardData.getData('text'),
                    index: this.selectionStart,
                });
            });

            textarea.addEventListener('cut', function (e) {
                nodeOTCient.commit({
                    type: 'delete',
                    text: this.value.substring(this.selectionStart, this.selectionEnd),
                    index: this.selectionStart,
                });
            });

            textarea.addEventListener('keydown', function (e) {
                var isBackspaceKey = (e.keyCode === KEY_CODE.BACKSPACE);
                var isDeleteKey = (e.keyCode === KEY_CODE.DELETE);

                if (!isBackspaceKey && !isDeleteKey) {
                    return;
                }

                var isSingleDelete = (this.selectionStart === this.selectionEnd);
                var isAtFirstCharacter = (this.selectionStart === 0);
                var isAtLastCharacter = (this.selectionEnd === this.length - 1);

                var deleteStart = this.selectionStart;
                var deleteEnd = this.selectionEnd;

                if (isSingleDelete) {
                    if (isBackspaceKey && !isAtFirstCharacter) {
                        deleteStart = this.selectionStart - 1;
                        deleteEnd = this.selectionStart;
                    } else if (isDeleteKey && !isAtLastCharacter) {
                        deleteStart = this.selectionEnd;
                        deleteEnd = this.selectionEnd + 1;
                    }
                }

                var deleteText = this.value.substring(deleteStart, deleteEnd);

                if (deleteText.length === 0) {
                    return;
                }

                nodeOTCient.commit({
                    type: 'delete',
                    text: deleteText,
                    index: deleteStart,
                });
            });

            var nodeOTCient = NodeOTClient.for(
                'http://localhost:3000',
                window.location.hash.substring(1) || 'PPBqWA9'
            );

            nodeOTCient.on('apply', applyOperation);

            function applyOperation(operation) {
                var selectionStart = textarea.selectionStart;
                var selectionEnd = textarea.selectionEnd;

                if (operation.type === 'insert') {
                    textarea.value = textarea.value.substring(0, operation.index) + operation.text + textarea.value.substring(operation.index);
                } else if (operation.type === 'delete') {
                    var deleteStart = operation.index;
                    var deleteEnd = operation.index + operation.text.length;
                    textarea.value = textarea.value.substring(0, deleteStart) + textarea.value.substring(deleteEnd);
                }

                var transformedSelectionStart = selectionStart;
                var transformedSelectionEnd = selectionEnd;

                if (operation.index < selectionStart) {
                    if (operation.type === 'insert') {
                        transformedSelectionStart += operation.text.length;
                        transformedSelectionEnd += operation.text.length;
                    } else if (operation.type === 'delete') {
                        transformedSelectionStart -= operation.text.length;
                        transformedSelectionEnd -= operation.text.length;
                    }
                }

                textarea.selectionStart = transformedSelectionStart;
                textarea.selectionEnd = transformedSelectionEnd;
            }

            window.addEventListener('hashchange', function (e) {
                var hash = window.location.hash.substring(1);
                if (hash === '') {
                    return;
                }

                window.location.hash = '#';

                var operation = JSON.parse(hash);
                applyOperation(operation);
                nodeOTCient.commit(operation);
            });
        </script>
    </body>
</html>