<!DOCTYPE html>
<html>
    <head>
        <link rel="stylesheet" type="text/css" href="reset.css" />
        <style type="text/css">
        textarea {
            box-sizing: border-box;
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
            padding: 15px 20px;
        }
        </style>
    </head>
    <body>
        <form>
            <textarea></textarea>
        </form>
        <script type="text/javascript" src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
        <script type="text/javascript" src="../dist/client.js"></script>
        <script type="text/javascript">
            var KEY_CODE = {
                BACKSPACE: 8,
                TAB: 9,
            }
            var tabDelimeter = '    ';
            var textarea = document.querySelector('textarea');

            textarea.focus();

            textarea.addEventListener('keydown', function (e) {
                switch (e.keyCode) {
                    case KEY_CODE.TAB: {
                        var startIndex = this.selectionStart;
                        var endIndex = this.selectionEnd;

                        this.value = this.value.substring(0, startIndex) + tabDelimeter + this.value.substring(endIndex);
                        this.selectionStart = this.selectionEnd = startIndex + tabDelimeter.length;

                        e.preventDefault();
                        break;
                    }
                    case KEY_CODE.BACKSPACE: {
                        var startIndex = this.selectionStart;
                        var endIndex = this.selectionEnd;

                        if (startIndex === endIndex && startIndex - tabDelimeter.length + 1 >= 0) {
                            if (isSoftTab(this.value, tabDelimeter, startIndex - tabDelimeter.length + 1)) {
                                return;
                            }

                            this.value = this.value.substring(0, startIndex - tabDelimeter.length) + this.value.substring(startIndex);
                            this.selectionStart = this.selectionEnd = startIndex;

                            e.preventDefault();
                        }

                        break;
                    }
                }
            });

            textarea.addEventListener('keypress', function (e) {
                var affectedText = this.value.substring(this.selectionStart, this.selectionEnd + 1);
                var affectedLines = toLines(affectedText);

                var startLines = toLines(this.value.substring(0, this.selectionStart));
                var endLines = toLines(this.value.substring(0, this.selectionEnd));

                var type = (e.keyCode === KEY_CODE.BACKSPACE) ? 'delete' : 'insert';

                var operation = {
                    type,
                    lines: [String.fromCharCode(e.keyCode)],
                    start: {
                        row: startLines.length - 1,
                        column: startLines[startLines.length - 1].length,
                    },
                    end: {
                        row: endLines.length - 1,
                        column: endLines[endLines.length - 1].length,
                    },
                };

                console.log(operation);

                nodeOTCient.commit(operation);
            });

            function toLines(string) {
                return string.split(/\r*\n/);
            }

            function isSoftTab(string, tabDelimeter, index) {
                for (var i = index, j = 0; j < tabDelimeter.length; ++i, ++j) {
                    if (string.charAt(i) !== tabDelimeter.charAt(j)) {
                        return false;
                    }
                }

                return true;
            }

            var nodeOTCient = NodeOTClient.for('http://localhost:3000', window.location.hash.substring(1) || 'PPBqWA9');
        </script>
    </body>
</html>